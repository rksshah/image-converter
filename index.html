<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Professional Image Upload & Convert</title>
  <!-- Bootstrap CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    /* Reset & base */
    body {
      display: flex;
      flex-direction: column;
      background: #f5f7fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    main {
      flex: 1 0 auto;
      padding-top: 30px;
      padding-bottom: 40px;
    }

    h2 {
      font-weight: 700;
      margin-bottom: 30px;
      color: #323232;
      text-align: center;
    }

    /* Drop zone style */
    .drop-zone {
      border: 2.5px dashed #6c757d;
      border-radius: 12px;
      background: #ffffff;
      padding: 50px 30px;
      text-align: center;
      color: #6c757d;
      font-size: 1.25rem;
      transition: background-color 0.3s ease, border-color 0.3s ease;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
      max-width: 700px !important;
      width: 100%;
    }
    .drop-zone:hover {
      border-color: #0d6efd;
      background-color: #e7f1ff;
      color: #0d6efd;
    }
    .drop-zone.dragover {
      border-color: #0d6efd;
      background-color: #cfe2ff;
      color: #084298;
      box-shadow: 0 0 10px 3px rgba(13, 110, 253, 0.4);
    }
    .drop-zone svg {
      margin-bottom: 15px;
      color: inherit;
      width: 56px;
      height: 56px;
    }

    /* Simple input box style */
    .file-input-wrapper {
      max-width: 360px;
      margin: 30px auto 40px auto;
      position: relative;
    }
    .file-input-wrapper input[type="file"] {
      display: none;
    }
    .file-input-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      cursor: pointer;
      border: 2px solid #6c757d;
      border-radius: 8px;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 1rem;
      transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
      background: white;
      color: #6c757d;
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.05);
      user-select: none;
    }
    .file-input-label:hover,
    .file-input-label:focus {
      border-color: #0d6efd;
      color: #0d6efd;
      background-color: #e9f2ff;
      outline: none;
      box-shadow: 0 0 8px 2px rgba(13,110,253,0.3);
    }
    .file-input-label svg {
      width: 22px;
      height: 22px;
      fill: currentColor;
      flex-shrink: 0;
    }

    /* Images container */
    #uploadedImages {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(140px,1fr));
      gap: 18px;
      margin-top: 30px;
    }
    .image-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
      cursor: pointer;
      overflow: hidden;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      display: flex;
      flex-direction: column;
      user-select: none;
    }
    .image-container:hover,
    .image-container:focus {
      outline: none;
      transform: scale(1.06);
      box-shadow: 0 8px 24px rgb(0 0 0 / 0.2);
    }
    .image-container img {
      width: 100%;
      object-fit: contain;
      max-height: 160px;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }
    .image-name {
      padding: 10px 8px;
      font-size: 14px;
      font-weight: 600;
      color: #495057;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      user-select: text;
    }

    /* Download all button */
    #downloadAllBtn {
      display: block;
      margin: 30px auto 0 auto;
      max-width: 240px;
      font-weight: 700;
      font-size: 1.1rem;
      padding: 14px 28px;
      border-radius: 12px;
      transition: box-shadow 0.3s ease;
      box-shadow: 0 4px 12px rgb(13 110 253 / 0.4);
    }
    #downloadAllBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }
    #downloadAllBtn:not(:disabled):hover {
      box-shadow: 0 6px 20px rgb(13 110 253 / 0.7);
    }

    /* Responsive */
    @media (max-width: 480px) {
      .drop-zone {
        padding: 40px 20px;
        font-size: 1.1rem;
      }
      .file-input-wrapper {
        max-width: 280px;
      }
      #downloadAllBtn {
        width: 100%;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <main role="main" aria-label="Image upload and conversion tool">
    <div class="container">
       <div class="top-box-section text-center m-auto">
        <!-- comment testing -->
         <h2>Upload & Convert Images Professionally </h2>

        <!-- Drag & Drop Zone -->
        <label for="dragDropInput" class="drop-zone" tabindex="0" aria-describedby="dragDropHelp" aria-label="Drag and drop images here or click to select files">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          <p class="mb-1">Drag & drop your images here</p>
          <small id="dragDropHelp" class="text-muted">(Supports multiple files, click to select too)</small>
          <input class="visually-hidden" type="file" id="dragDropInput" accept="image/*" multiple aria-hidden="true" />
        </label>

        <!-- Output format selector -->
        <div class="my-4 text-center">
          <label for="formatSelect" class="form-label fs-5 fw-semibold me-3">Convert images to:</label>
          <select id="formatSelect" class="form-select d-inline-block w-auto" aria-label="Choose image conversion format">
            <option value="webp" selected>WebP</option>
            <option value="jpeg">JPEG</option>
            <option value="png">PNG</option>
          </select>
        </div>

        <!-- Download All Button -->
        <button id="downloadAllBtn" class="btn btn-primary" disabled aria-disabled="true">Download All</button>
       </div>

      <!-- Converted images container -->
      <section id="uploadedImages" aria-live="polite" aria-relevant="additions" role="list"></section>
    </div>
  </main>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function() {
      const dragDropInput = document.getElementById("dragDropInput");
      const dropZone = dragDropInput.closest("label.drop-zone");
      const formatSelect = document.getElementById("formatSelect");
      const uploadedImages = document.getElementById("uploadedImages");
      const downloadAllBtn = document.getElementById("downloadAllBtn");
      let convertedImages = [];

      // Prevent default drag behaviors
      ["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => {
        dropZone.addEventListener(eventName, e => {
          e.preventDefault();
          e.stopPropagation();
        });
      });

      // Highlight drop zone on dragover
      ["dragenter", "dragover"].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.add("dragover");
        });
      });
      ["dragleave", "drop"].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.remove("dragover");
        });
      });

      // Handle dropped files
      dropZone.addEventListener("drop", e => {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
      });

      // Handle dragDropInput file selection
      dragDropInput.addEventListener("change", () => {
        if (dragDropInput.files.length) {
          handleFiles(dragDropInput.files);
        }
      });

      // Convert image file to chosen format
      function convertImage(imageFile, format) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = e => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement("canvas");
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0);

              let mimeType = "image/webp";
              if(format === "jpeg") mimeType = "image/jpeg";
              else if(format === "png") mimeType = "image/png";

              canvas.toBlob(blob => {
                if(blob) resolve({ blob });
                else reject(new Error("Conversion failed"));
              }, mimeType, 0.92);
            };
            img.onerror = () => reject(new Error("Image load failed"));
            img.src = e.target.result;
          };
          reader.onerror = () => reject(new Error("File read failed"));
          reader.readAsDataURL(imageFile);
        });
      }

      // Clear previous converted images and revoke URLs
      function clearConvertedImages() {
        convertedImages.forEach(({ url }) => URL.revokeObjectURL(url));
        convertedImages.length = 0;
        uploadedImages.innerHTML = "";
      }

      // Create image card
      function createImageCard(name, blob) {
        const item = document.createElement("article");
        item.className = "image-container";
        item.tabIndex = 0;
        item.setAttribute("role", "listitem");
        item.setAttribute("aria-label", `Click to download ${name}`);

        const url = URL.createObjectURL(blob);

        const img = document.createElement("img");
        img.src = url;
        img.alt = name;
        img.loading = "lazy";

        const caption = document.createElement("div");
        caption.className = "image-name";
        caption.title = name;
        caption.textContent = name;

        item.appendChild(img);
        item.appendChild(caption);

        // Click or keyboard enter/space triggers download
        item.addEventListener("click", e => {
          e.preventDefault();
          downloadBlob(blob, name);
        });
        item.addEventListener("keydown", e => {
          if (["Enter", " ", "Spacebar"].includes(e.key)) {
            e.preventDefault();
            downloadBlob(blob, name);
          }
        });

        return { element: item, url };
      }

      // Download helper
      function downloadBlob(blob, filename) {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
      }

      // Handle FileList or Array of files
      async function handleFiles(files) {
        if (!files.length) return;
        clearConvertedImages();
        downloadAllBtn.disabled = true;
        downloadAllBtn.setAttribute("aria-disabled", "true");

        const outputFormat = formatSelect.value.toLowerCase();
        const fileArray = Array.from(files);

        for (const file of fileArray) {
          if (!file.type.startsWith("image")) continue;

          try {
            const { blob } = await convertImage(file, outputFormat);

            let baseName = file.name.replace(/\.[^/.]+$/, "");
            const ext = outputFormat === "jpeg" ? "jpg" : outputFormat;
            const newName = `${baseName}.${ext}`;

            const { element, url } = createImageCard(newName, blob);
            uploadedImages.appendChild(element);
            convertedImages.push({ name: newName, blob, url });

          } catch (err) {
            alert(`Failed to convert '${file.name}': ${err.message}`);
          }
        }

        if (convertedImages.length) {
          downloadAllBtn.disabled = false;
          downloadAllBtn.setAttribute("aria-disabled", "false");
          downloadAllBtn.focus();
        }
      }

      // Load JSZip dynamically for zip download
      function loadJsZip() {
        return new Promise((resolve, reject) => {
          if (window.JSZip) return resolve(window.JSZip);
          const script = document.createElement("script");
          script.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js";
          script.onload = () => resolve(window.JSZip);
          script.onerror = () => reject(new Error("Failed to load JSZip"));
          document.head.appendChild(script);
        });
      }

      async function createAndDownloadZip(images) {
        try {
          const JSZip = await loadJsZip();
          const zip = new JSZip();

          for (const img of images) {
            // We must await blob.arrayBuffer() correctly:
            const buffer = await img.blob.arrayBuffer();
            zip.file(img.name, buffer);
          }
          const content = await zip.generateAsync({ type: "blob" });
          downloadBlob(content, "converted-images.zip");
        } catch (err) {
          alert("Failed to create ZIP archive: " + err.message);
        }
      }

      // Modified download all button click - ensure promise chain and disable double clicks
      downloadAllBtn.addEventListener("click", async () => {
        if (!convertedImages.length) return;

        downloadAllBtn.disabled = true;
        downloadAllBtn.setAttribute("aria-disabled", "true");

        try {
          if (convertedImages.length === 1) {
            const { name, blob } = convertedImages[0];
            downloadBlob(blob, name);
          } else {
            await createAndDownloadZip(convertedImages);
          }
        } catch (e) {
          alert('Download failed: ' + e.message);
        } finally {
          downloadAllBtn.disabled = false;
          downloadAllBtn.setAttribute("aria-disabled", "false");
        }
      });
    })();
  </script>
</body>
</html>